name: Sync Event Log

on:
  # Run daily at 09:00 UTC (2:00 AM PT, 1:00 AM PT during DST)
  schedule:
    - cron: '0 9 * * *'
  
  # Also run on push to main branch (in case we want to trigger manually)
  push:
    branches: [ main ]
  
  # Allow manual triggering from GitHub UI
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no changes detected'
        required: false
        default: 'false'

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push changes
    
    steps:
    - name: Checkout village-chronicle
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # Fetch all history for proper diffing
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
    
    - name: Run sync script
      run: |
        python sync_events.py
    
    - name: Check for changes
      id: check_changes
      run: |
        if git diff --quiet; then
          echo "no_changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“­ No changes detected"
        else
          echo "no_changes=false" >> $GITHUB_OUTPUT
          echo "ðŸ“ Changes detected!"
          git diff --stat
        fi
    
    - name: Configure Git
      if: steps.check_changes.outputs.no_changes == 'false'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
    
    - name: Commit and push changes
      if: steps.check_changes.outputs.no_changes == 'false'
      run: |
        git add events.json
        git commit -m "chore: sync events.json from village-event-log
        
        Automated sync from https://github.com/ai-village-agents/village-event-log
        
        - Events: ${{ fromJSON(steps.get_stats.outputs.data).events || 'N/A' }}
        - Days: ${{ fromJSON(steps.get_stats.outputs.data).days || 'N/A' }}
        - Last updated: ${{ fromJSON(steps.get_stats.outputs.data).last_updated || 'N/A' }}"
        
        git push origin main
    
    - name: Extract event stats
      id: get_stats
      run: |
        python -c "
        import json
        try:
            with open('events.json', 'r') as f:
                data = json.load(f)
            events = len(data.get('events', []))
            days = data.get('metadata', {}).get('days_covered', 0)
            last_updated = data.get('metadata', {}).get('last_updated', '')
            stats = {'events': events, 'days': days, 'last_updated': last_updated}
            print(f'data={json.dumps(stats)}')
        except Exception as e:
            print(f'data={{\"error\": \"{str(e)}\"}}')
        " >> $GITHUB_OUTPUT
    
    - name: Post sync summary
      if: always()
      run: |
        echo "ðŸ“Š Sync Summary:"
        echo "Changes detected: ${{ steps.check_changes.outputs.no_changes == 'false' }}"
        echo "Total events: ${{ fromJSON(steps.get_stats.outputs.data).events || 'N/A' }}"
        echo "Days covered: ${{ fromJSON(steps.get_stats.outputs.data).days || 'N/A' }}"
        echo "Last updated: ${{ fromJSON(steps.get_stats.outputs.data).last_updated || 'N/A' }}"
